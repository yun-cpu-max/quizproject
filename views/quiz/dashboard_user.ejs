<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/style.css">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, var(--primary-color), #6a4bcc);
            min-height: 100vh;
            color: var(--text-color);
             /* Adjusted for fixed navbar */
        }
        .container {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .dashboard-header {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .dashboard-header h1 {
            color: white;
            font-weight: 700;
            font-size: 2rem;
        }
        .summary-card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
        }
        .summary-card .card-title {
            color: var(--secondary-color);
            font-weight: 600;
            font-size: 1.1rem;
        }
        .summary-card .card-text.display-4 {
            color: var(--secondary-color);
            font-weight: 700;
        }
        .section-title {
            margin-top: 3rem;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }
        .table th {
            color: white;
            background-color: var(--secondary-color);
            font-weight: 600;
        }
        .table td {
            color: var(--text-color);
        }
        .table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .chart-placeholder {
            height: 200px;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #6c757d;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .review-item {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .review-item h5 {
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 0.8rem;
        }
        .review-item p {
             color: var(--text-color);
        }

        @media (max-width: 768px) {
            body {
                padding-top: 60px; /* Adjust for smaller screens */
            }
             .dashboard-header h1 {
                 font-size: 1.5rem;
             }
             .section-title {
                 font-size: 1.5rem;
                 margin-top: 2rem;
             }
             .summary-card .card-title {
                 font-size: 1rem;
             }
             .summary-card .card-text.display-4 {
                 font-size: 2rem;
             }
             .review-item {
                 padding: 1rem;
                 margin-bottom: 1rem;
             }
             .review-item h5 {
                 font-size: 1rem;
             }
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/home.png" alt="ë¡œê³ " class="logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-house-door"></i> í™ˆ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/notice"><i class="bi bi-bell"></i> ê³µì§€ì‚¬í•­</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/ranking"><i class="bi bi-trophy"></i> ë­í‚¹</a>
                    </li>
                    <% if (user) { %>
                        <li class="nav-item">
                            <span class="nav-link active"><i class="bi bi-person"></i> <%= user.username %>ë‹˜!</span>
                        </li>
                    <% } %>
                </ul>
                <div class="d-flex">
                    <% if (user) {
                         if (user.role === 'admin') { %>
                         <a href="/admin" class="btn btn-warning me-2"><i class="bi bi-gear"></i> ê´€ë¦¬ì</a>
                         <% }
                         %> <a href="/myprofile" class="btn btn-outline-light me-2"><i class="bi bi-person-circle"></i> ë‚´ì •ë³´</a>
                        <a href="/logout" class="btn btn-outline-light"><i class="bi bi-box-arrow-right"></i> ë¡œê·¸ì•„ì›ƒ</a>
                    <% } else { %>
                        <a href="/login" class="btn btn-outline-light me-2"><i class="bi bi-box-arrow-in-right"></i> ë¡œê·¸ì¸</a>
                        <a href="/signup" class="btn btn-light"><i class="bi bi-person-plus"></i> íšŒì›ê°€ì…</a>
                    <% } %>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1><span role="img" aria-label="chart">ğŸ“Š</span> ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ</h1>
        </div>

        <!-- ìš”ì•½ ì¹´ë“œ ì„¹ì…˜ -->
        <div class="row text-center">
            <div class="col-md-4">
                <div class="card summary-card">
                    <div class="card-body">
                        <h5 class="card-title"><span role="img" aria-label="check">âœ”ï¸</span> ì´ ì‘ì‹œ í€´ì¦ˆ ìˆ˜</h5>
                        <p class="card-text display-4" id="totalQuizzes">12</p>
                        <p class="card-text"><small class="text-muted">ì‘ì‹œí•œ í€´ì¦ˆ ìˆ˜</small></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card summary-card">
                    <div class="card-body">
                        <h5 class="card-title"><span role="img" aria-label="chart">ğŸ“Š</span> í‰ê·  ì ìˆ˜</h5>
                        <p class="card-text display-4" id="averageScore">82ì </p>
                        <p class="card-text"><small class="text-muted">ì „ì²´ í‰ê· </small></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card summary-card">
                    <div class="card-body">
                        <h5 class="card-title"><span role="img" aria-label="target">ğŸ¯</span> ì •ë‹µë¥ </h5>
                        <p class="card-text display-4" id="correctRate">76%</p>
                        <p class="card-text"><small class="text-muted">ì´ ì •ë‹µ ë¹„ìœ¨</small></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìµœê·¼ ì‘ì‹œ ê¸°ë¡ ì„¹ì…˜ -->
        <h2 class="section-title"><span role="img" aria-label="calendar">ğŸ“…</span> ìµœê·¼ ì‘ì‹œ ê¸°ë¡</h2>
        <div class="table-responsive">
            <table class="table table-hover table-bordered">
                <thead class="thead-light">
                    <tr>
                        <th>í€´ì¦ˆ ì œëª©</th>
                        <th>ì‘ì‹œ ë‚ ì§œ</th>
                        <th>ì ìˆ˜</th>
                        <th>ì •ë‹µë¥ </th>
                        <th>ë‹¤ì‹œ í’€ê¸°</th>
                    </tr>
                </thead>
                <tbody id="recentAttemptsTable">
                    <!-- ë°ì´í„°ëŠ” JavaScriptë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. -->
                </tbody>
            </table>
        </div>

        <!-- í€´ì¦ˆ í†µê³„ ì‹œê°í™” ì„¹ì…˜ -->
        <h2 class="section-title"><span role="img" aria-label="stats">ğŸ“Š</span> í€´ì¦ˆ í†µê³„ ì‹œê°í™”</h2>
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card summary-card h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-center mb-3">ì¹´í…Œê³ ë¦¬ë³„ ì‘ì‹œ íšŸìˆ˜</h5>
                        <div class="chart-container" style="position: relative; height:300px; width:100%;">
                            <canvas id="categoryAttemptsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card summary-card h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-center mb-3">ì›”ë³„ ì‘ì‹œ íšŸìˆ˜</h5>
                        <div class="chart-container" style="position: relative; height:300px; width:100%;">
                            <canvas id="monthlyAttemptsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë‹µ ë³µìŠµ ì„¹ì…˜ -->
        <h2 class="section-title"><span role="img" aria-label="memo">ğŸ“</span> ì˜¤ë‹µ ë³µìŠµ ì„¹ì…˜</h2>
        <div id="wrongAnswersSection">
            <!-- ë°ì´í„°ëŠ” JavaScriptë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script>
        const totalQuizzesVal = "<%= typeof totalQuizzes !== 'undefined' ? totalQuizzes : 0 %>";
        const averageScoreVal = "<%= typeof averageScore !== 'undefined' ? averageScore : '0' %>";
        const correctRateVal = "<%= typeof correctRate !== 'undefined' ? correctRate : '0' %>";   

        const recentAttemptsData = JSON.parse('<%- JSON.stringify(typeof recentAttempts !== "undefined" ? recentAttempts : []) %>');
        const wrongAnswersData = JSON.parse('<%- JSON.stringify(typeof wrongAnswers !== "undefined" ? wrongAnswers : []) %>');
        const serverError = "<%= typeof error !== 'undefined' ? error : '' %>";

        // ì„œë²„ë¡œë¶€í„° ì „ë‹¬ë°›ì„ ì°¨íŠ¸ ë°ì´í„° (ë°±ì—”ë“œì—ì„œ ì´ í˜•ì‹ìœ¼ë¡œ ì „ë‹¬ í•„ìš”)
        const categoryChartData = JSON.parse('<%- JSON.stringify(typeof categoryChartData !== "undefined" ? categoryChartData : {labels: [], data: []}) %>');
        const monthlyChartData = JSON.parse('<%- JSON.stringify(typeof monthlyChartData !== "undefined" ? monthlyChartData : {labels: [], data: []}) %>');

        document.addEventListener('DOMContentLoaded', function () {
            if (serverError) {
                const errorDiv = document.createElement('div');
                errorDiv.classList.add('alert', 'alert-danger');
                errorDiv.textContent = serverError;
                document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.dashboard-header').nextSibling);
            }

            document.getElementById('totalQuizzes').textContent = totalQuizzesVal;
            document.getElementById('averageScore').textContent = averageScoreVal + "ì ";
            document.getElementById('correctRate').textContent = correctRateVal + "%";

            const recentAttemptsTableBody = document.getElementById('recentAttemptsTable');
            recentAttemptsTableBody.innerHTML = ''; 
            if (recentAttemptsData.length > 0) {
                recentAttemptsData.forEach(attempt => {
                    const row = recentAttemptsTableBody.insertRow();
                    row.insertCell().textContent = attempt.quizTitle;
                    row.insertCell().textContent = attempt.attemptDate; 
                    row.insertCell().textContent = attempt.score + "ì  / " + attempt.totalQuestions + "ë¬¸ì œ";
                    row.insertCell().textContent = attempt.rate; 
                    const retryButtonCell = row.insertCell();
                    const button = document.createElement('button');
                    button.classList.add('btn', 'btn-sm', 'btn-outline-primary');
                    button.textContent = 'ë‹¤ì‹œ í’€ê¸°';
                    button.onclick = function() { location.href = `/quiz/list/${attempt.quizId}`; };
                    retryButtonCell.appendChild(button);
                });
            } else {
                const row = recentAttemptsTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5;
                cell.textContent = 'ìµœê·¼ ì‘ì‹œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
                cell.classList.add('text-center');
            }

            const wrongAnswersDiv = document.getElementById('wrongAnswersSection');
            wrongAnswersDiv.innerHTML = ''; 
            if (wrongAnswersData.length > 0) {
                wrongAnswersData.forEach(item => {
                    const reviewItemDiv = document.createElement('div');
                    reviewItemDiv.classList.add('review-item');
                    const explanationId = `explanation-${item.quizId}-${item.questionId}`; 
                    reviewItemDiv.innerHTML = `
                        <h5><span role="img" aria-label="cross mark">âŒ</span> ${item.quizTitle} - ${item.questionNumber}ë²ˆ ë¬¸ì œ</h5>
                        <p><strong>Q:</strong> ${item.questionText}</p>
                        <p><strong>ë‚´ ë‹µë³€:</strong> <span class="text-danger">${item.myAnswer}</span> / <strong>ì •ë‹µ:</strong> <span class="text-success">${item.correctAnswer}</span></p>
                        <button class="btn btn-sm btn-info" onclick="toggleExplanation('${explanationId}')">í•´ì„¤ ë³´ê¸°</button>
                        <div id="${explanationId}" style="display:none; margin-top:10px; padding:10px; border:1px solid #eee; background-color:#f9f9f9;">
                            ${item.explanation}
                        </div>
                    `; 
                    wrongAnswersDiv.appendChild(reviewItemDiv);
                });
            } else {
                const noReviewDiv = document.createElement('div');
                noReviewDiv.classList.add('alert', 'alert-light');
                noReviewDiv.textContent = 'ì˜¤ë‹µ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì˜í•˜ì…¨ì–´ìš”!';
                wrongAnswersDiv.appendChild(noReviewDiv);
            }

            // ì¹´í…Œê³ ë¦¬ë³„ ì‘ì‹œ íšŸìˆ˜ ì°¨íŠ¸ (Pie Chart)
            const categoryCtx = document.getElementById('categoryAttemptsChart');
            if (categoryCtx && categoryChartData.labels && categoryChartData.labels.length > 0) {
                new Chart(categoryCtx, {
                    type: 'pie',
                    data: {
                        labels: categoryChartData.labels,
                        datasets: [{
                            label: 'ì¹´í…Œê³ ë¦¬ë³„ ì‘ì‹œ íšŸìˆ˜',
                            data: categoryChartData.data,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)',
                                'rgba(199, 199, 199, 0.7)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(199, 199, 199, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            } else if (categoryCtx) {
                categoryCtx.getContext('2d').fillText('ì¹´í…Œê³ ë¦¬ë³„ ì‘ì‹œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 10, 50);
            }

            // ì›”ë³„ ì‘ì‹œ íšŸìˆ˜ ì°¨íŠ¸ (Bar Chart)
            const monthlyCtx = document.getElementById('monthlyAttemptsChart');
            if (monthlyCtx && monthlyChartData.labels && monthlyChartData.labels.length > 0) {
                new Chart(monthlyCtx, {
                    type: 'bar',
                    data: {
                        labels: monthlyChartData.labels,
                        datasets: [{
                            label: 'ì›”ë³„ ì‘ì‹œ íšŸìˆ˜',
                            data: monthlyChartData.data,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1 // ì •ìˆ˜ ë‹¨ìœ„ë¡œ yì¶• í‘œì‹œ
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            } else if (monthlyCtx) {
                monthlyCtx.getContext('2d').fillText('ì›”ë³„ ì‘ì‹œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 10, 50);
            }
        });

        function toggleExplanation(elementId) {
            const explanationDiv = document.getElementById(elementId);
            if (explanationDiv) {
                explanationDiv.style.display = explanationDiv.style.display === "none" ? "block" : "none";
            }
        }
    </script>
</body>
</html>
